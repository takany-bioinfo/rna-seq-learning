---
title: "DGE_02ï¼š Rã§è¡Œã†å·®æ¬¡çš„éºä¼å­ç™ºç¾è§£æï¼ˆDESeq2ã¨å¯è¦–åŒ–ï¼‰"
author: "takany"
date: "2025-09-27"
output:
  html_document:
    self_contained: true
    css: style.css
---

### ã¯ã˜ã‚ã«  
ã€€ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€Google Colab Notebookã€Œrns-seq_02ã€ã§ä½œæˆã—ãŸ count.txt ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã„ã€Rã§å·®æ¬¡çš„éºä¼å­ç™ºç¾è§£æï¼ˆDGEè§£æï¼‰ã‚’è¡Œã„ã¾ã™ã€‚ä½¿ç”¨ã™ã‚‹ã®ã¯å…¬é–‹ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§ã™ãŒã€å…ƒè«–æ–‡ã®è‘—è€…ã‚„ç ”ç©¶å†…å®¹ã¨ã¯é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãŸã€æœ¬è§£æã®çµæœã‚’ã‚‚ã¨ã«ç ”ç©¶ã®è©•ä¾¡ã‚„ç§‘å­¦çš„ãªè­°è«–ã‚’è¡Œã†ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚


### ä½¿ç”¨ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
##### ------- Installing Required Packages-------

```{r, message = FALSE, warning=FALSE}
suppressPackageStartupMessages({
  if (!requireNamespace("BiocManager", quietly = TRUE)) {
  install.packages(
    "BiocManager",
    repos = "https://cloud.r-project.org"
  )
}

if (!requireNamespace("DESeq2", quietly = TRUE)) { 
  BiocManager::install(
    "DESeq2"
  )
}
library(DESeq2)

if (!requireNamespace("pheatmap", quietly = TRUE)) {
  BiocManager::install("pheatmap")
  }

library(pheatmap)
})  

```

### ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢
##### -------Data preparation-------

æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚ã‚‰ã‹ã˜ã‚ç”¨æ„ã—ã¦ãŠã<br>

 - meta.csvã€ãƒªãƒ¼ãƒ‰åã¨æ¡ä»¶ãƒ¬ãƒ™ãƒ«ï¼ˆ"stage"ï¼‰ã‚’è¨˜è¼‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«<br>
 - stage_level.csvã€æ¡ä»¶ãƒ¬ãƒ™ãƒ«ï¼ˆ"stage"ï¼‰ã‚’ãƒ¬ãƒ™ãƒ«é †ã«è¨˜è¼‰ã—ãŸ<br>

The following files should be prepared beforehand:<br> 

 â€“ meta.csv, which records sample names and their associated condition levels (stage)<br>
 â€“ stage_level.csv, which defines the order of the condition levels (stage)<br>
<br>

â€» meta.csvã¨stage_level.csv ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆæœ€åˆã®6è¡Œï¼‰ 
```{r, echo = FALSE, message = FALSE}

file1 <- readLines("./data/meta.csv", n = 6)
file2 <- readLines("./data/stage_level.csv", n = 6)
for (i in 1:6) {
  cat(sprintf("%-40s | %-40s\n", file1[i], file2[i]))
}
```

 
 - featureCountsã®å‡ºåŠ›ã‹ã‚‰6åˆ—ç›®ä»¥é™ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã€åˆ—åã‚’ã‚µãƒ³ãƒ—ãƒ«åã®ã¿ã«æ•´ç†ã™ã‚‹ã€‚<br>
 
 - ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®æ¡ä»¶ãƒ¬ãƒ™ãƒ«ã‚’å› å­ã«å¤‰æ›ã—ã¦é †åºã‚’è¨­å®šã—ã€ãã®é †ã«åŸºã¥ã„ã¦ã‚«ã‚¦ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®åˆ—ã‚’ä¸¦ã³æ›¿ãˆã‚‹ã€‚<br>

 - Extract count data from the 6th column onward in the featureCounts output and rename the columns to sample names only.
 
 - Convert the condition levels in the metadata to factors with specified order, and reorder the columns of the count data accordingly.

```{r}
##### -----Meta Data prep-------

metadata <- read.csv("./data/meta.csv",
                     row.names=1,
                     stringsAsFactors = FALSE
                     ) 
 
stage_levels <- read.csv("./data/stage_level.csv", 
                         stringsAsFactors = FALSE
                         )[[1]]

metadata$stage <- factor(metadata$stage,
                         levels = stage_levels
                         ) 

metadata <- metadata[order(metadata$stage),
                     ,
                     drop = FALSE
                     ] 

###### -------Count Data preparation-------

counts <- read.table("./data/counts.txt",
                     header = TRUE,
                     sep = "\t", 
                     comment.char = "#", 
                     row.names = 1
                    )

count_matrix <- counts[,
                       6:ncol(counts)  
                       ]                    

ori_colnames <- colnames(count_matrix) 

new_colnames <- substr(ori_colnames,
                          11, 
                          20           
                          ) 
colnames(count_matrix) <- new_colnames 


##### Reordering count_matrix columns to match metadata 

count_matrix <- count_matrix[, rownames(metadata)] 

if (all(colnames(count_matrix) == rownames(metadata))) {
  print("OK, Match confirmed !") 
  } else { stop("Error: Names don't match.")
  }

```

<div style="font-size:70%">
```{r, echo = FALSE}
knitr::kable(head(count_matrix), 
             format = "html",
             caption = "count_matrixã®å…ˆé ­æ•°è¡Œ"
             )
```
</div>

### DESeq2 ã«ã‚ˆã‚‹å·®æ¬¡çš„éºä¼å­ç™ºç¾è§£æ

##### -------Differential Expression Analysis with DESeq2-------

```{r, message = FALSE}
dds <- DESeqDataSetFromMatrix(countData = count_matrix,
                              colData = metadata,
                              design = ~ stage 
                              ) 
dds <- dds[rowSums(counts(dds)) >= 10, ] # Exclude genes with low total counts (less than 10) as noise.

dds_result <- DESeq(dds)

```

##### -------Extracting data from dds_result-------

```{R}
condition <- colnames(metadata)[1] 
reference_level <- stage_levels[1]  

res_list <- list()
sum_list <- list()

for (i in 2:length(stage_levels)) {
  target_level <- stage_levels[i]
  name <- paste0(target_level, "_vs_", reference_level)
  
  res <- results(dds_result, contrast = c("stage", target_level, reference_level))
  
  res_list[[name]] <- res
  sum_list[[name]] <- capture.output(summary(res))
}
```


### è§£æçµæœã®å¯è¦–åŒ–

#### -------MA plot-------

```{r, fig.height=7,fig.width=9}
par(mfrow = c(2, 2))

for (name in names(res_list)) {
  res <- res_list[[name]]
  plotMA(res,
         main = paste0("MA plot: ", name),
         ylim = c(-10, 10),
         alpha = 0.001)
}
```

<small>â€» ã‚·ãƒ­ã‚¤ãƒŒãƒŠã‚ºãƒŠã®èŠ±ç²‰ã¯3ç´°èƒæ€§ã§ã‚ã‚Šã€1ç´°èƒæœŸï¼ˆuninucleateï¼‰ã‹ã‚‰2ç´°èƒæœŸï¼ˆbicellularã€late bicellularï¼‰ã€3ç´°èƒæœŸï¼ˆtricellularï¼‰ã‚’çµŒã¦æˆç†ŸèŠ±ç²‰ï¼ˆmatureï¼‰ã¨ãªã‚‹ã€‚<br>

ğŸ”· ç™ºé”æ®µéšã”ã¨ã«ç™ºç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå¤‰åŒ–ã—ã¦ã„ã‚‹ã“ã¨ãŒç¤ºå”†ã•ã‚Œã‚‹ã€‚<br>

ğŸ”· åˆæœŸæ®µéšï¼ˆbicellular ã¾ã§ï¼‰ã¯å¤§ããªç™ºç¾å¤‰å‹•ãŒå°‘ãªã„ã€‚<br>

ğŸ”· late bicellular ä»¥é™ã§è»¢å†™å¤‰å‹•ãŒæ˜ç¢ºã¨ãªã‚Šã€tricellular æœŸã§ã¯ã•ã‚‰ã«é¡•è‘—ã«ãªã‚‹ã€‚<br>

ğŸ”· mature æœŸã§ã¯ä¸Šæ–¹åˆ¶å¾¡éºä¼å­ãŒå¤šãã€æˆç†Ÿç‰¹ç•°çš„ãªç™ºç¾ãŒç¤ºå”†ã•ã‚Œã‚‹ã€‚<br></small>

#### -------Volcano Plot-------

```{r,fig.height=8, fig.width=9}
par(mfrow = c(2, 2))

for (name in names(res_list)) {

    res <- res_list[[name]]
    valid <- !is.na(res$padj) & !is.na(res$log2FoldChange) # Filter out rows with NA values
    res <- res[valid, ]

     plot(res$log2FoldChange, 
          -log10(res$padj), 
          pch = 20, 
          col = ifelse(res$padj < 0.001 & abs(res$log2FoldChange) >= 1,
                       "red",
                       "grey"
                       ),
          xlab = "log2(Fold Change)",
          ylab = "-log10(Adjusted p-value)",
          main = name )

}
```

â€»MA plotã¯ç™ºç¾é‡ã«å¯¾ã™ã‚‹å¤‰å‹•å¹…ã‚’ç¤ºã—ã€Volcano plotã¯å¤‰å‹•å¹…ã¨çµ±è¨ˆçš„æœ‰æ„æ€§ã‚’åŒæ™‚ã«ç¤ºã™ã€‚

ğŸ”· MA plotã®çµæœã‚’è£œå¼·ã—ã€ç™ºé”æ®µéšã”ã¨ã®æœ‰æ„ãªç™ºç¾å¤‰å‹•ã‚’æ˜ç¢ºã«ã—ã¦ã„ã‚‹ã€‚


#### -------PCA plot-------

```{r, fig.width=7,fig.height=2, out.width="70%"}

vsd <- vst(dds, blind=FALSE)  

plotPCA(vsd, intgroup = c(condition))
```
<br>
<small>ğŸ”· ç™ºé”æ®µéšã”ã¨ã«ã‚µãƒ³ãƒ—ãƒ«ãŒæ˜ç¢ºã«ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã€‚<br>

ğŸ”· ä¸»æˆåˆ†1ï¼ˆPC1ï¼‰ãŒå…¨ä½“ã®å¤‰å‹•ã®å¤§éƒ¨åˆ†ã‚’èª¬æ˜ã—ã¦ãŠã‚Šã€ç™ºé”æ®µéšãŒéºä¼å­ç™ºç¾ã®ä¸»è¦ãªå¤‰å‹•è¦å› ã§ã‚ã‚‹ã“ã¨ãŒç¤ºå”†ã•ã‚Œã‚‹ã€‚<br></small>





#### -------Heat map-------

```{r}
mat <- assay(vsd)  

pheatmap( mat, 
          scale = "row",
          clustering_distance_rows = "correlation", 
          clustering_method = "average",  
          cluster_cols = FALSE,
          annotation_row = NA,        
          annotation_col = metadata["stage"],  
          show_rownames = FALSE,  
          angle_col = 45,  
          main = "Heatmap" 
          )

```

<small>ğŸ”· ç™ºé”æ®µéšã‚°ãƒ«ãƒ¼ãƒ—é–“ã®ç™ºç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é¡ä¼¼æ€§ãŒè¦–è¦šçš„ã«ç¢ºèªã§ãã‚‹ã€‚<br>

ğŸ”· ç‰¹å®šã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«æ¡ä»¶ç‰¹ç•°çš„ãªç™ºç¾å‚¾å‘ãŒè¦‹ã‚‰ã‚Œã‚‹ã€‚<br></small>



### å·®æ¬¡çš„ç™ºç¾éºä¼å­ï¼ˆDEGsï¼‰ã®æŠ½å‡º

#### -------Identification of Differentially Expressed Genes (DEGs)-------

```{r}
gene_list <- list()

for (name in names(res_list)) {
  res <- res_list[[name]]
  res <- res[!is.na(res$padj), ]
  sig <- res[res$padj < 0.001, ]
  
  sig <- sig[order(abs(sig$log2FoldChange),
                   decreasing = TRUE),
             ] 
  top_gene <- rownames(sig)[1:20]
  gene_list[[name]] <- top_gene
}

gene_list_all <- unique(unlist(gene_list))

```

#### -------Plot Counts-------

å¤‰å‹•é‡ã®å¤§ãã„4ã¤ã®éºä¼å­ã«ã¤ã„ã¦ãƒ—ãƒ­ãƒƒãƒˆã—ã¦ã¿ã‚‹<br>
Plotting the four most variable genes
```{r, fig.height=7}

par(mfrow = c(2, 2))

for (gene_id in gene_list_all[1:4])
{
  plotCounts(dds,
             gene = gene_id, 
             intgroup = condition, 
             main = gene_id
            )
}

```
<br>
<small>ğŸ”· éºä¼å­ã”ã¨ã«ã€ç™ºé”æ®µéšã«ä¼´ã†ç™ºç¾ã®å¤‰å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã«é•ã„ãŒè¦‹ã‚‰ã‚Œã‚‹ã€‚<br></small>
<br>

##### --------Heatmap of Top Variable Genes--------

```{r, fig.height=6,fig.width=7}
mat_top <- assay(vsd)[gene_list_all[1:50],] 

pheatmap(mat_top,scale = "row",
         clustering_distance_rows = "correlation",
         clustering_method = "average",
         annotation_row = NA,
         annotation_col = metadata["stage"],
         show_rownames = TRUE, 
         angle_col = 45, 
         fontsize_row = 5,
         fontsize = 7,
         main = "Heatmap for genes with highest LFC"
         )
```
<br>
<small>ğŸ”· å¤‰å‹•ãŒå¤§ãã„éºä¼å­ã«çµã‚‹ã“ã¨ã§ã€ç™ºé”æ®µéšé–“ã®é¡•è‘—ãªé•ã„ãŒã‚ˆã‚Šæ˜ç­ã«å¯è¦–åŒ–ã•ã‚Œã¦ã„ã‚‹ã€‚<br>
ğŸ”· éºä¼å­ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã”ã¨ã«ã€ç™ºé”æ®µéšã«å¿œã˜ãŸç‰¹å¾´çš„ãªç™ºç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒèªã‚ã‚‰ã‚Œã‚‹ã€‚<br></small>

---

#### ã¾ã¨ã‚
<small>1ç´°èƒæœŸã‹ã‚‰2ç´°èƒæœŸã¸ã®ç§»è¡Œæ®µéšã§ã¯ã€è»¢å†™ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ¯”è¼ƒçš„å®‰å®šã—ã¦ã„ã‚‹ã‚ˆã†ã«ã¿ãˆã‚‹ã€‚ç™ºé”ãŒé€²ã‚€ã«ã¤ã‚Œã¦ã€éºä¼å­ç™ºç¾ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®å†ç·¨ãŒé€²è¡Œã™ã‚‹å…†å€™ãŒè¦³å¯Ÿã•ã‚Œã‚‹ã€‚ç‰¹ã«3ç´°èƒæœŸã§ã¯ã€å¤šæ•°ã®éºä¼å­ãŒå¤§ããç™ºç¾å¤‰å‹•ã—ã€ä»£è¬çµŒè·¯ã‚„æ©Ÿèƒ½çš„ãªè»¢æ›æœŸã‚’åæ˜ ã™ã‚‹å¯èƒ½æ€§ãŒç¤ºå”†ã•ã‚Œã‚‹ã€‚æˆç†Ÿæ®µéšã«ãŠã„ã¦ã¯ã€ã‚¢ãƒƒãƒ—ãƒ¬ã‚®ãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç¤ºã™éºä¼å­ãŒå¢—ãˆã‚‹å‚¾å‘ãŒã¿ã‚‰ã‚Œã€æˆç†Ÿæ®µéšã®ç”Ÿç†çš„ãƒ»æ©Ÿèƒ½çš„å¤‰åŒ–ãŒéºä¼å­ç™ºç¾ã«åæ˜ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒæ¨æ¸¬ã•ã‚Œã‚‹ã€‚</small>

---


#### ãƒ»ãƒ»ãƒ»ãƒ»ä»Šå›ã®è§£æã¯ã“ã“ã¾ã§ã¨ãªã‚Šã¾ã™ã€‚  
<br>
â€»ã“ã®ã‚ã¨ã€æŠ½å‡ºã—ãŸéºä¼å­IDã‚’ã‚‚ã¨ã«ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ã—ã€ç”Ÿç‰©å­¦çš„ãªæ„ç¾©ã«ã¤ã„ã¦è€ƒå¯Ÿã—ã¦ã„ãã“ã¨ã«ãªã‚Šã¾ã™ã€‚<br>
<br>



